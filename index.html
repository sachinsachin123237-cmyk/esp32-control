<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hand Gesture MQTT Controller</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0f0;
      text-align: center;
    }
    canvas {
      border: 2px solid #0f0;
      border-radius: 8px;
    }
    .status {
      margin-top: 10px;
      font-size: 18px;
    }
  </style>
</head>

<body>
  <h2>üñê Hand Gesture ‚Üí ESP32 MQTT Control</h2>

  <!-- Canvas is the ONLY visible output -->
  <canvas id="canvas" width="640" height="480"></canvas>

  <!-- Video hidden -->
  <video id="video" autoplay playsinline style="display:none;"></video>

  <div class="status">Detected Fingers: <span id="fingerCount">STOP</span></div>
  <div class="status">MQTT Status: <span id="mqttStatus">Disconnected</span></div>
  <div class="status">Last Sent: <span id="lastSent">None</span></div>

<script>
/* ================= MQTT CONFIG ================= */
const MQTT_BROKER =
  "wss://da5d5e6e407e495db2c68d35b34b405b.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_USERNAME = "wheel";
const MQTT_PASSWORD = "Wheel123";
const MQTT_TOPIC = "wheelchair/motor/control";
/* =============================================== */

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const fingerCountEl = document.getElementById("fingerCount");
const mqttStatusEl = document.getElementById("mqttStatus");
const lastSentEl = document.getElementById("lastSent");

let lastCommand = null;

/* ================= MQTT ================= */
const client = mqtt.connect(MQTT_BROKER, {
  username: MQTT_USERNAME,
  password: MQTT_PASSWORD,
  reconnectPeriod: 2000
});

client.on("connect", () => mqttStatusEl.textContent = "Connected");
client.on("reconnect", () => mqttStatusEl.textContent = "Reconnecting...");
client.on("offline", () => mqttStatusEl.textContent = "Offline");

/* ================= SEND ================= */
function sendCommand(cmd) {
  if (cmd !== lastCommand && client.connected) {
    client.publish(MQTT_TOPIC, String(cmd));
    lastSentEl.textContent = cmd;
    lastCommand = cmd;
  }
}

/* ================= FINGER COUNT ================= */
function countFingers(lm) {
  const tips = [4, 8, 12, 16, 20];
  const pips = [2, 6, 10, 14, 18];
  let count = 0;

  if (lm[tips[0]].x < lm[pips[0]].x) count++; // thumb
  for (let i = 1; i < 5; i++) {
    if (lm[tips[i]].y < lm[pips[i]].y) count++;
  }
  return count;
}

/* ================= MEDIAPIPE ================= */
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // DRAW CAMERA IMAGE (FIXES BLACK SCREEN)
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (results.multiHandLandmarks?.length) {
    const lm = results.multiHandLandmarks[0];

    drawConnectors(ctx, lm, HAND_CONNECTIONS, { color: "#00ff00", lineWidth: 3 });
    drawLandmarks(ctx, lm, { color: "#ff0000", radius: 4 });

    const fingers = countFingers(lm);

    if (fingers >= 1 && fingers <= 5) {
      fingerCountEl.textContent = fingers;
      sendCommand(fingers);
    } else {
      fingerCountEl.textContent = "STOP";
      sendCommand("STOP");
    }
  } else {
    fingerCountEl.textContent = "STOP";
    sendCommand("STOP");
  }
  ctx.restore();
});

/* ================= CAMERA ================= */
const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();
</script>
</body>
</html>
