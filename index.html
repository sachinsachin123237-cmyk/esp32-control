<!DOCTYPE html>
<html>
<head>
    <title>Wheelchair Joystick Control</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        body { text-align:center; font-family:Arial; background:#f0f0f0; touch-action: none; }
        #joystick-zone { 
            width: 100%; height: 300px; background: #ddd; 
            position: relative; margin: 20px 0; border-radius: 20px;
        }
        .stop-btn { 
            background:#f44336; color:white; padding:20px; width:80%; 
            font-size:24px; border:none; border-radius:10px; cursor:pointer; 
        }
        #status { font-size:18px; color:#1976D2; margin: 10px; }
    </style>
</head>
<body>
    <h1>ðŸ¦½ Manual Joystick Control</h1>
    <div id="status">Connecting...</div>

    <div id="joystick-zone"></div>

    <button class="stop-btn" onclick="sendCmd('STOP')">STOP ALL</button>

    <script>
        const broker = 'wss://da5d5e6e407e495db2c68d35b34b405b.s1.eu.hivemq.cloud:8884/mqtt';
        const client = mqtt.connect(broker, {
            username: 'wheel',
            password: 'Wheel123',
            clientId: 'web_joy_' + Math.random().toString(16).substr(2, 8)
        });

        client.on('connect', () => { document.getElementById('status').innerText = "Connected"; });

        // Initialize Joystick
        const manager = nipplejs.create({
            zone: document.getElementById('joystick-zone'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'blue',
            size: 150
        });

        let lastSend = 0;
        manager.on('move', (evt, data) => {
            const now = Date.now();
            if (now - lastSend > 100) { // Throttle to 10 messages per second
                const x = Math.round(data.instance.frontPosition.x);
                const y = Math.round(data.instance.frontPosition.y) * -1;
                client.publish('sachin/esp32/nav/control', `JOY:${x},${y}`);
                lastSend = now;
            }
        });

        manager.on('end', () => { client.publish('sachin/esp32/nav/control', 'STOP'); });

        function sendCmd(cmd) { client.publish('sachin/esp32/nav/control', cmd); }
    </script>
</body>
</html>
