<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hand Gesture MQTT Controller</title>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0f0;
      text-align: center;
    }
    video, canvas {
      border: 2px solid #0f0;
      border-radius: 8px;
    }
    .status {
      margin-top: 10px;
      font-size: 18px;
    }
  </style>
</head>

<body>
  <h2>üñê Hand Gesture ‚Üí ESP32 MQTT Control</h2>

  <video id="video" width="640" height="480" autoplay muted></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <div class="status">Detected Fingers: <span id="fingerCount">STOP</span></div>
  <div class="status">MQTT Status: <span id="mqttStatus">Disconnected</span></div>
  <div class="status">Last Sent: <span id="lastSent">None</span></div>

<script>
/* ================= MQTT CONFIG ================= */
const MQTT_BROKER = "da5d5e6e407e495db2c68d35b34b405b.s1.eu.hivemq.cloud"; // CHANGE IF NEEDED
const MQTT_USERNAME = "wheel";                  // OPTIONAL
const MQTT_PASSWORD = "Wheel123";                  // OPTIONAL
const MQTT_TOPIC = "wheelchair/motor/control";
/* =============================================== */

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const fingerCountEl = document.getElementById("fingerCount");
const mqttStatusEl = document.getElementById("mqttStatus");
const lastSentEl = document.getElementById("lastSent");

let lastCommand = null;

/* ================= MQTT SETUP ================= */
const client = mqtt.connect(MQTT_BROKER, {
  username: MQTT_USERNAME,
  password: MQTT_PASSWORD,
  reconnectPeriod: 2000
});

client.on("connect", () => {
  mqttStatusEl.textContent = "Connected";
});

client.on("reconnect", () => {
  mqttStatusEl.textContent = "Reconnecting...";
});

client.on("offline", () => {
  mqttStatusEl.textContent = "Offline";
});

/* ============== SEND COMMAND ================= */
function sendCommand(cmd) {
  if (cmd !== lastCommand && client.connected) {
    client.publish(MQTT_TOPIC, String(cmd));
    lastSentEl.textContent = cmd;
    lastCommand = cmd;
  }
}

/* ============== FINGER COUNT ================= */
function countFingers(landmarks) {
  const tips = [4, 8, 12, 16, 20];
  const pips = [2, 6, 10, 14, 18];
  let count = 0;

  // Thumb (x-axis check)
  if (landmarks[tips[0]].x < landmarks[pips[0]].x) count++;

  // Other fingers (y-axis check)
  for (let i = 1; i < 5; i++) {
    if (landmarks[tips[i]].y < landmarks[pips[i]].y) count++;
  }
  return count;
}

/* ================= MEDIAPIPE ================= */
const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    const landmarks = results.multiHandLandmarks[0];
    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: "#0f0"});
    drawLandmarks(ctx, landmarks, {color: "#f00", radius: 4});

    const fingers = countFingers(landmarks);

    if (fingers >= 1 && fingers <= 5) {
      fingerCountEl.textContent = fingers;
      sendCommand(fingers);
    } else {
      fingerCountEl.textContent = "STOP";
      sendCommand("STOP");
    }
  } else {
    fingerCountEl.textContent = "STOP";
    sendCommand("STOP");
  }
});

/* ================= CAMERA ================= */
const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 640,
  height: 480
});
camera.start();

</script>
</body>
</html>

